<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EDATA | AFA Registration</title>
  <style>
    :root{
      --primary:#0A3D62; --accent:#1DD1A1; --bg:#F5F7FA; --card:#fff;
      --text:#0f172a; --muted:#64748b; --line:#e2e8f0; --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:24px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 24px rgba(15,23,42,.06);overflow:hidden}
    .top{
      padding:16px 16px;
      background:linear-gradient(90deg,var(--primary),#082f49);
      color:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap
    }
    .top h1{font-size:18px;margin:0;font-weight:800}
    .price{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.24);padding:8px 12px;border-radius:999px;font-weight:800}
    .body{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700}
    input{
      width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:10px;font-size:14px;outline:none
    }
    input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(29,209,161,.18)}
    .section{margin-top:14px;border-top:1px dashed var(--line);padding-top:14px}
    .hint{font-size:13px;color:var(--muted);margin:8px 0 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:0;cursor:pointer;border-radius:10px;padding:12px 14px;font-weight:800
    }
    .btn-primary{background:var(--accent);color:#053b2a}
    .btn-muted{background:#eef2f7;color:#111827}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .status{margin-top:10px;font-size:13px}
    .ok{color:#16a34a;font-weight:800}
    .bad{color:var(--danger);font-weight:800}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2f7;border:1px solid var(--line);font-size:12px;font-weight:800}
    .hidden{display:none}
    .overlay{
      position:fixed;inset:0;background:rgba(15,23,42,.55);
      display:none;align-items:center;justify-content:center;padding:16px;z-index:9999
    }
    .overlay .box{
      width:min(520px,100%);
      background:#fff;border-radius:14px;border:1px solid var(--line);
      padding:16px;box-shadow:0 18px 50px rgba(0,0,0,.25)
    }
    .overlay h3{margin:0 0 8px;font-size:16px}
    .overlay p{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.45}
    .overlay .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}


    /* ===== Overlay Upgrades ===== */
.overlay{display:none;align-items:center;justify-content:center}
.overlay .box{position:relative}
.overlay-head{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  margin-bottom:10px;
}
.xbtn{
  border:0;background:#eef2f7;border:1px solid var(--line);
  width:36px;height:36px;border-radius:10px;
  font-weight:900;cursor:pointer;
}
.xbtn:hover{filter:brightness(.98)}
.overlay-msg{margin-top:10px}
.loader-wrap{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;padding:10px 0;
}
.spinner{
  width:64px;height:64px;border-radius:50%;
  border:6px solid #e5e7eb;          /* light ring */
  border-top-color: var(--accent);    /* spinning color */
  animation: spin 0.9s linear infinite;
}
.loader-text{
  font-size:13px;color:var(--muted);font-weight:800;text-align:center;
}
@keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <h1>AFA Registration</h1>
        <div class="price">Price: GHS <span id="priceText">15</span></div>
      </div>

      <div class="body">
        <div class="grid">
          <div>
            <label>Full Name</label>
            <input id="full_name" placeholder="Enter full name" />
          </div>
          <div>
            <label>Phone Number</label>
            <input id="phone_number" placeholder="e.g. 024xxxxxxx" />
          </div>

          <div>
            <label>ID Number</label>
            <input id="id_number" placeholder="Enter ID number" />
          </div>
          <div>
            <label>Date of Birth</label>
            <input id="date_of_birth" type="date" />
          </div>

          <div>
            <label>Town</label>
            <input id="town" placeholder="Enter town" />
          </div>
          <div>
            <label>Occupation</label>
            <input id="occupation" placeholder="Enter occupation" />
          </div>

          <div style="grid-column:1/-1">
            <label>Email Address</label>
            <input id="email" placeholder="example@email.com" />
          </div>
        </div>

        <div class="section">
          <div class="row">
            <button class="btn btn-danger" id="cancelBtn">Cancel</button>
            <button class="btn btn-primary" id="startPayBtn">Complete Payment</button>
            <span class="pill" id="stepPill">Step: Form</span>
          </div>
          <div class="status" id="statusLine"></div>

          <!-- MoMo + OTP section -->
          <div id="paySection" class="hidden" style="margin-top:14px">
            <div class="grid">
              <div>
                <label>MoMo Number (to receive OTP + prompt)</label>
                <input id="momo_number" placeholder="e.g. 024xxxxxxx or +233..." />
              </div>
              <div>
                <label>OTP Code</label>
                <input id="otp_code" placeholder="Enter OTP here" />
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn btn-muted" id="sendOtpBtn">Send OTP</button>
              <button class="btn btn-muted" id="verifyOtpBtn">Verify OTP</button>
              <button class="btn btn-primary hidden" id="payNowBtn">Pay Now (GHS 15)</button>
            </div>

            <p class="hint">
              Flow: Send OTP → Verify OTP → Pay Now → Approve prompt on your phone.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
<div class="overlay" id="overlay">
  <div class="box">
    <div class="overlay-head">
      <h3 id="overlayTitle">Processing</h3>
      <button class="xbtn" id="overlayClose" title="Close">✕</button>
    </div>

    <div class="loader-wrap" id="loaderWrap">
      <div class="spinner"></div>
      <div class="loader-text" id="loaderText">Please wait…</div>
    </div>

    <p id="overlayMsg" class="overlay-msg">...</p>

    <div class="actions" id="overlayActions">
      <button class="btn btn-primary hidden" id="overlayDone">Done</button>
    </div>
  </div>
</div>


<script>
  // ✅ Set this to your live backend base URL if different
const API_BASE =
  location.hostname === "localhost"
    ? "http://localhost:8080"
    : "https://edatagh.com/edatagh-backend";

  const AFA_PRICE = 15;

  // State
  let registrationId = null;
  let otpSessionId = null;
  let transactionId = null;

  const OTP_COOLDOWN_MS = 20000; // match backend cooldown (20s)

function resetAfaForm() {
  // reset inputs
  ["full_name","phone_number","id_number","date_of_birth","town","occupation","email","momo_number","otp_code"]
    .forEach(id => { const el = $(id); if(el) el.value = ""; });

  // reset state
  registrationId = null;
  otpSessionId = null;
  transactionId = null;

  // reset buttons + UI
  $("paySection").classList.add("hidden");
  $("payNowBtn").classList.add("hidden");
  $("payNowBtn").disabled = false;

  $("sendOtpBtn").disabled = false;
  $("sendOtpBtn").textContent = "Send OTP";

  $("verifyOtpBtn").disabled = false;
  $("verifyOtpBtn").textContent = "Verify OTP";

  $("startPayBtn").disabled = false;

  setStep("Form");
  setStatus("Fill the form and click Complete Payment.", true);
}


  const $ = (id)=>document.getElementById(id);

 function openOverlay({ title, msg, loading=true, closable=false, doneBtn=false, loaderText="Please wait…" }) {
  $("overlayTitle").textContent = title || "Message";
  $("overlayMsg").textContent = msg || "";
  $("overlay").style.display = "flex";

  $("loaderWrap").style.display = loading ? "flex" : "none";
  $("loaderText").textContent = loaderText;

  // closable?
  $("overlayClose").style.display = closable ? "inline-flex" : "none";

  // done button?
  $("overlayDone").classList.toggle("hidden", !doneBtn);
}

function closeOverlay() {
  $("overlay").style.display = "none";
}

$("overlayClose").onclick = closeOverlay;
$("overlayDone").onclick = closeOverlay;


  function setStatus(msg, ok=true){
    $("statusLine").innerHTML = ok ? `<span class="ok">${msg}</span>` : `<span class="bad">${msg}</span>`;
  }

  function setStep(name){
    $("stepPill").textContent = "Step: " + name;
  }

  function getFormData(){
    return {
      full_name: $("full_name").value.trim(),
      phone_number: $("phone_number").value.trim(),
      id_number: $("id_number").value.trim(),
      date_of_birth: $("date_of_birth").value,
      town: $("town").value.trim(),
      occupation: $("occupation").value.trim(),
      email: $("email").value.trim()
    };
  }

  function validateForm(d){
    if(!d.full_name || !d.phone_number || !d.id_number || !d.date_of_birth || !d.town || !d.occupation || !d.email){
      return "Please fill all fields.";
    }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(d.email)) return "Invalid email format.";
    return null;
  }

  async function postJSON(url, body) {
  const r = await fetch(API_BASE + url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });

  const text = await r.text(); // ✅ allow html/xml too
  try {
    return JSON.parse(text);
  } catch {
    return { ok: false, message: `Server did not return JSON. Status ${r.status}. ${text.slice(0, 160)}...` };
  }
}

async function getJSON(url) {
  const r = await fetch(API_BASE + url);
  const text = await r.text();
  try {
    return JSON.parse(text);
  } catch {
    return { ok: false, message: `Server did not return JSON. Status ${r.status}. ${text.slice(0, 160)}...` };
  }
}
  $("cancelBtn").onclick = ()=>{
    // simple reset (or redirect)
    location.reload();
  };

  $("startPayBtn").onclick = async ()=>{
    const d = getFormData();
    const err = validateForm(d);
    if(err) return showOverlay("Form Required", err);

    // Ask for momo number next
    $("paySection").classList.remove("hidden");
    setStep("MoMo");
    setStatus("Enter MoMo number, then click Send OTP.", true);
    showOverlay("Payment", `AFA price is GHS ${AFA_PRICE}. Enter MoMo number to continue.`);
  };

  $("sendOtpBtn").onclick = async () => {
  const momo = $("momo_number").value.trim();
  if (!momo) return openOverlay({ title: "MoMo Number", msg: "Please enter MoMo number.", loading: false, closable: true, doneBtn: true });

  // ✅ Disable immediately to prevent spam-clicking
  $("sendOtpBtn").disabled = true;
  $("sendOtpBtn").textContent = "Sending...";

  try {
    // create draft registration first (so we have an ID in DB)
    if (!registrationId) {
      const d = getFormData();
      const err = validateForm(d);
      if (err) {
        $("sendOtpBtn").disabled = false;
        $("sendOtpBtn").textContent = "Send OTP";
        return openOverlay({ title: "Form Required", msg: err, loading: false, closable: true, doneBtn: true });
      }

      const create = await postJSON("/api/afa/create-draft", { ...d, price: AFA_PRICE });
      if (!create.ok) {
        $("sendOtpBtn").disabled = false;
        $("sendOtpBtn").textContent = "Send OTP";
        openOverlay({ title: "Create Draft Failed", msg: create.message || "Backend rejected request.", loading: false, closable: true, doneBtn: true });
        return setStatus("Draft creation failed. Check API_BASE / backend route.", false);
      }
      registrationId = create.registration_id;
    }

    setStatus("Sending OTP...", true);

    const r = await postJSON("/api/send-momo-otp", { momo_number: momo });
    if (!r.ok) {
      $("sendOtpBtn").disabled = false;
      $("sendOtpBtn").textContent = "Send OTP";
      return setStatus(r.message || "Failed to send OTP.", false);
    }

    otpSessionId = r.session_id;
    setStep("OTP");
    setStatus("OTP sent. Enter OTP and click Verify OTP.", true);

    // ✅ Keep disabled for cooldown
    let remaining = Math.ceil(OTP_COOLDOWN_MS / 1000);
    $("sendOtpBtn").textContent = `Resend in ${remaining}s`;

    const t = setInterval(() => {
      remaining -= 1;
      if (remaining <= 0) {
        clearInterval(t);
        $("sendOtpBtn").disabled = false;
        $("sendOtpBtn").textContent = "Send OTP";
      } else {
        $("sendOtpBtn").textContent = `Resend in ${remaining}s`;
      }
    }, 1000);

  } catch (e) {
    $("sendOtpBtn").disabled = false;
    $("sendOtpBtn").textContent = "Send OTP";
    setStatus("Network error. Try again.", false);
  }
};


  $("verifyOtpBtn").onclick = async ()=>{
    const momo = $("momo_number").value.trim();
    const otp = $("otp_code").value.trim();
    if(!momo) return showOverlay("MoMo Number", "Please enter MoMo number.");
    if(!otp) return showOverlay("OTP", "Please enter OTP.");

    setStatus("Verifying OTP...", true);
    const r = await postJSON("/api/verify-momo-otp", {
      momo_number: momo,
      otp,
      session_id: otpSessionId
    });

    if(!r.ok) return setStatus(r.message || "OTP verify failed.", false);

    // refresh real session id returned (important)
    otpSessionId = r.session_id || otpSessionId;

    $("payNowBtn").classList.remove("hidden");
    setStep("Pay");
    setStatus("OTP verified. Click Pay Now to receive MoMo prompt.", true);
  };

$("payNowBtn").onclick = async () => {
  if (!registrationId) return setStatus("Registration missing. Start again.", false);

  const momo = $("momo_number").value.trim();
  if (!momo) {
    openOverlay({ title: "MoMo Number", msg: "Please enter MoMo number.", loading: false, closable: true, doneBtn: true });
    return;
  }

  // ✅ Show processing alert + spinner
  openOverlay({
    title: "Processing Payment",
    msg: "A payment prompt has been sent to your phone. Please enter your MoMo PIN to approve.",
    loading: true,
    closable: false,
    doneBtn: false,
    loaderText: "Waiting for approval…\nWAIT TILL STATUS CHANGES TO SUCCESS BEFORE LEAVING THIS PAGE"
  });

  $("payNowBtn").disabled = true;

  const r = await postJSON("/api/afa/pay", {
    registration_id: registrationId,
    momo_number: momo,
    otp_session_id: otpSessionId
  });

  if (!r.ok) {
    $("payNowBtn").disabled = false;
    openOverlay({ title: "Payment Error", msg: r.message || "Payment init failed.", loading: false, closable: true, doneBtn: true });
    return setStatus(r.message || "Payment init failed.", false);
  }

  transactionId = r.transaction_id;

  // ✅ Start polling until approved/failed
  await pollPaymentStatus(transactionId);
};

async function pollPaymentStatus(txid){
  const started = Date.now();
  const timeoutMs = 3 * 60 * 1000;

  while(Date.now() - started < timeoutMs){
    const s = await getJSON(`/api/afa/status?transaction_id=${encodeURIComponent(txid)}`);
  if (s.ok && s.status === "approved") {
  setStatus("✅ Payment approved and registration saved.", true);

  openOverlay({
    title: "Payment Successful",
    msg: "✅ Payment approved. Your AFA registration is completed.",
    loading: false,
    closable: true,
    doneBtn: true
  });

  // ✅ Reset everything after a short moment
  setTimeout(() => {
    resetAfaForm();
  }, 800);

  return;
}

    if(s.ok && s.status === "failed"){
      setStatus("❌ Payment failed.", false);
      openOverlay({ title:"Failed", msg:"Payment failed or was cancelled.", loading:false, closable:true, doneBtn:true });
      $("payNowBtn").disabled = false;
      return;
    }

    // keep the loader text changing slightly so user feels progress
    $("loaderText").textContent = "Waiting for approval…";
    await new Promise(r=>setTimeout(r, 4000));
  }

  setStatus("Still pending. If you already approved, the system will update shortly.", true);
  openOverlay({
    title:"Pending",
    msg:"If you already approved on your phone, your payment will still be confirmed shortly even if you close this page.",
    loading:false,
    closable:true,
    doneBtn:true
  });
  $("payNowBtn").disabled = false;
}


  // init price
  $("priceText").textContent = AFA_PRICE;
</script>
</body>
</html>
