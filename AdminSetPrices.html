<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | Set Prices</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary:#0A3D62; --accent:#1DD1A1; --bg:#F5F7FA; --card:#fff;
      --text:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --danger:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box;font-family:Poppins,system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
    .top{
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:14px
    }
    .title{font-size:20px;font-weight:800}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:16px;
      box-shadow:0 10px 30px rgba(2,6,23,.06);padding:14px
    }

    .grid{
      display:grid;gap:10px;
      grid-template-columns: 1.2fr 2fr 1fr auto;
      align-items:end
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input,.field select{
      width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;
      background:#fff;font-size:14px;outline:none
    }
    .field input:focus,.field select:focus{border-color:rgba(10,61,98,.5)}

    .btn{
      border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;
      background:var(--primary);color:#fff;white-space:nowrap
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-outline{
      background:#fff;color:var(--primary);border:1px solid rgba(10,61,98,.25)
    }
    .btn-danger{background:var(--danger)}
    .btn-warn{background:var(--warn);color:#111827}

    .table-wrap{margin-top:12px;overflow:auto;border-radius:14px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:860px;background:#fff}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{font-size:12px;color:var(--muted);font-weight:800;background:#f8fafc}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800
    }
    .pill.active{background:rgba(29,209,161,.15);color:#047857}
    .pill.inactive{background:rgba(239,68,68,.12);color:#b91c1c}

    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini{
      padding:9px 10px;border-radius:10px;font-size:12px;font-weight:800
    }

    .toast{
      margin-top:10px;font-size:13px;color:var(--muted)
    }

    @media (max-width: 760px){
      .grid{grid-template-columns:1fr;align-items:stretch}
      .btn{width:100%}
      table{min-width:760px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">Set Prices (Admin)</div>
        <div class="sub">Add, update, activate or deactivate prices. Loads automatically on page open.</div>
      </div>
      <button class="btn btn-outline" id="btnReload">Reload</button>
    </div>

    <div class="card">
      <div class="grid">
        <div class="field">
          <label>Network</label>
          <select id="network">
            <option value="mtn">MTN</option>
            <option value="telecel">Telecel</option>
            <option value="airteltigo">AirtelTigo</option>
          </select>
        </div>

        <div class="field">
          <label>Package Name</label>
          <input id="package_name" placeholder="e.g. 1GB / 2GB / AFA / Weekly" />
        </div>

        <div class="field">
          <label>Price (GHS)</label>
          <input id="price" type="number" step="0.01" placeholder="e.g. 6.00" />
        </div>

        <button class="btn" id="btnAdd">Add Price</button>
      </div>

      <div class="toast" id="msg"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Network</th>
              <th>Package Name</th>
              <th>Price (GHS)</th>
              <th>Status</th>
              <th style="width:320px">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" style="color:#64748b">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // ✅ Change this if your backend is hosted elsewhere
  const API_BASE = ""; // e.g. "https://vendor.sandipay.co" or "http://localhost:5000"

  const tbody = document.getElementById("tbody");
  const msg = document.getElementById("msg");

  const elNetwork = document.getElementById("network");
  const elName = document.getElementById("package_name");
  const elPrice = document.getElementById("price");

  const btnAdd = document.getElementById("btnAdd");
  const btnReload = document.getElementById("btnReload");

  function setMsg(text, isError=false){
    msg.textContent = text || "";
    msg.style.color = isError ? "#b91c1c" : "#64748b";
  }

  function niceNet(n){
    n = String(n || "").toLowerCase();
    if(n === "mtn") return "MTN";
    if(n === "telecel") return "TELECEL";
    if(n === "airteltigo") return "AIRTELTIGO";
    return n.toUpperCase();
  }

  async function loadPrices(){
    setMsg("Loading prices...");
    tbody.innerHTML = `<tr><td colspan="6" style="color:#64748b">Loading...</td></tr>`;
    try{
      const r = await fetch(`${API_BASE}/api/admin-prices`);
      const data = await r.json();
      if(!data.ok) throw new Error(data.message || "Failed to load");

      const rows = data.rows || [];
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="6" style="color:#64748b">No prices yet. Add one above.</td></tr>`;
        setMsg("No prices found.");
        return;
      }

      tbody.innerHTML = rows.map(row => {
        const st = String(row.status || "active").toLowerCase();
        const pillClass = st === "active" ? "active" : "inactive";
        const nextStatus = st === "active" ? "inactive" : "active";
        const toggleText = st === "active" ? "Deactivate" : "Activate";
        const toggleBtnClass = st === "active" ? "btn-danger" : "btn";

        return `
          <tr data-id="${row.id}">
            <td>${row.id}</td>
            <td>
              <select class="edit-network" style="padding:10px;border:1px solid var(--line);border-radius:10px">
                <option value="mtn" ${String(row.network).toLowerCase()==="mtn"?"selected":""}>MTN</option>
                <option value="telecel" ${String(row.network).toLowerCase()==="telecel"?"selected":""}>Telecel</option>
                <option value="airteltigo" ${String(row.network).toLowerCase()==="airteltigo"?"selected":""}>AirtelTigo</option>
              </select>
            </td>
            <td><input class="edit-name" value="${(row.package_name||"").replaceAll('"','&quot;')}" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px" /></td>
            <td><input class="edit-price" type="number" step="0.01" value="${row.price}" style="width:140px;padding:10px;border:1px solid var(--line);border-radius:10px" /></td>
            <td><span class="pill ${pillClass}">${st.toUpperCase()}</span></td>
            <td>
              <div class="row-actions">
                <button class="btn mini btn-warn" onclick="updateRow(${row.id})">Update</button>
                <button class="btn mini ${toggleBtnClass}" onclick="toggleStatus(${row.id}, '${nextStatus}')">${toggleText}</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      setMsg("Prices loaded.");
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="6" style="color:#b91c1c">Failed to load prices.</td></tr>`;
      setMsg(e.message || "Error", true);
    }
  }

  async function addPrice(){
    const network = elNetwork.value;
    const package_name = elName.value.trim();
    const price = elPrice.value;

    if(!package_name) return setMsg("Enter package name.", true);
    if(price === "" || Number(price) <= 0) return setMsg("Enter a valid price.", true);

    btnAdd.disabled = true;
    setMsg("Adding price...");

    try{
      const r = await fetch(`${API_BASE}/api/admin-prices`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ network, package_name, price })
      });
      const data = await r.json();
      if(!data.ok) throw new Error(data.message || "Failed to add");

      elName.value = "";
      elPrice.value = "";
      setMsg("Price added successfully.");
      await loadPrices();
    }catch(e){
      setMsg(e.message || "Error", true);
    }finally{
      btnAdd.disabled = false;
    }
  }

  window.updateRow = async function(id){
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    if(!tr) return;

    const network = tr.querySelector(".edit-network").value;
    const package_name = tr.querySelector(".edit-name").value.trim();
    const price = tr.querySelector(".edit-price").value;

    if(!package_name) return setMsg("Package name cannot be empty.", true);
    if(price === "" || Number(price) <= 0) return setMsg("Enter a valid price.", true);

    setMsg(`Updating ID ${id}...`);
    try{
      const r = await fetch(`${API_BASE}/api/admin-prices/${id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ network, package_name, price })
      });
      const data = await r.json();
      if(!data.ok) throw new Error(data.message || "Failed to update");
      setMsg("Updated successfully.");
      await loadPrices();
    }catch(e){
      setMsg(e.message || "Error", true);
    }
  }

  window.toggleStatus = async function(id, status){
    setMsg(`Setting status for ID ${id} to ${status}...`);
    try{
      const r = await fetch(`${API_BASE}/api/admin-prices/${id}/status`, {
        method:"PATCH",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ status })
      });
      const data = await r.json();
      if(!data.ok) throw new Error(data.message || "Failed to update status");
      setMsg("Status updated.");
      await loadPrices();
    }catch(e){
      setMsg(e.message || "Error", true);
    }
  }

  btnAdd.addEventListener("click", addPrice);
  btnReload.addEventListener("click", loadPrices);

  // ✅ auto load on page open
  loadPrices();
</script>
</body>
</html>
