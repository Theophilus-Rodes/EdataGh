<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MTN Data Bundles</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --green:#16A34A;
      --green-soft:#ECFDF3;
      --bg:#F9FAFB;
      --card:#FFFFFF;
      --text:#0F172A;
      --muted:#6B7280;
      --border:#E5E7EB;
      --danger:#DC2626;
    }

    *{box-sizing:border-box;font-family:Inter,system-ui}
    body{ margin:0; background:var(--bg); color:var(--text); }

    .header{
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:14px 16px;
      position:sticky; top:0; z-index:10;
    }
    .header-inner{
      max-width:1100px; margin:auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px;}
    .badge{
      background:var(--green-soft); color:var(--green);
      padding:6px 12px; border-radius:999px; font-size:12px; font-weight:600;
    }

    .wrap{max-width:1100px; margin:auto; padding:20px 16px 40px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; gap:10px;}
    .back{
      border:none; background:var(--green-soft); color:var(--green);
      padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
    }

    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px;}
    .pkg{
      background:var(--card); border-radius:16px; padding:18px; border:1px solid var(--border);
      display:flex; flex-direction:column; transition:.25s;
    }
    .pkg:hover{
      transform:translateY(-4px);
      box-shadow:0 12px 25px rgba(0,0,0,.08);
      border-color:var(--green);
    }
    .pkg h4{margin:0 0 6px; font-size:16px;}
    .price{font-size:20px; font-weight:700; color:var(--green); margin:6px 0;}
    .meta{font-size:12px; color:var(--muted); margin-bottom:14px;}
    .btn{
      margin-top:auto; border:none; border-radius:12px; padding:12px;
      background:var(--green); color:#fff; font-weight:600; cursor:pointer;
    }
    .empty{text-align:center; color:var(--muted); margin-top:30px;}

    /* MODAL */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:14px; z-index:1000;
    }
    .modal{width:100%; max-width:520px; background:#fff; border-radius:18px; padding:18px;}
    .modal-header{display:flex; justify-content:space-between; gap:10px;}
    .modal-header h3{margin:0; font-size:16px}
    .modal-sub{font-size:12px; color:var(--muted); margin-top:4px;}
    .x{border:none; background:none; font-size:22px; cursor:pointer;}
    .field{margin-top:12px;}
    .field label{font-size:12px; color:var(--muted);}
    .field input{
      width:100%; padding:12px; border-radius:10px;
      border:1px solid var(--border); margin-top:6px; font-size:14px;
    }
    .helper{
      margin-top:12px;
      font-size:12px;
      background:var(--green-soft);
      padding:10px;
      border-radius:10px;
    }
    .modal-footer{
      margin-top:16px;
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:10px;
    }
    .btn-ghost{background:#F3F4F6; color:#111;}
    .err{color:var(--danger); font-size:12px; margin-top:10px;}

    /* OVERLAY */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:1200;
    }
    .overlay-card{
      background:#fff; padding:20px; border-radius:16px; text-align:center;
      width:90%; max-width:420px;
    }
    .spinner{
      width:44px; height:44px; border-radius:50%;
      border:4px solid #E5E7EB; border-top-color:var(--green);
      margin:10px auto; animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<header class="header">
  <div class="header-inner">
    <div class="brand">MTN Data Bundles</div>
    <div class="badge">MTN Network</div>
  </div>
</header>

<div class="wrap">
  <div class="topbar">
    <button class="back" onclick="location.href='index.html'">← Back</button>
    <small style="color:var(--muted)">Select a bundle to continue</small>
  </div>

  <div id="packages" class="grid"></div>
  <div id="empty" class="empty">Loading MTN packages...</div>
</div>

<!-- ✅ BUY MODAL -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h3 id="mTitle">Buy Bundle</h3>
        <div class="modal-sub" id="mSub">Fill details below</div>
      </div>
      <button class="x" onclick="closeModal()">×</button>
    </div>

    <div class="helper" id="mSummary">Package: - | Amount: -</div>

    <div class="field">
      <label>Receiver Number</label>
      <input id="receiverNumber" placeholder="e.g. 024xxxxxxx" inputmode="tel" />
    </div>

    <div class="field">
      <label>MoMo Number (payer)</label>
      <input id="momoNumber" placeholder="e.g. 055xxxxxxx" inputmode="tel" />
    </div>

    <div class="field" id="otpField" style="display:none;">
      <label>OTP Code</label>
      <input id="otpCode" placeholder="Enter OTP" inputmode="numeric" />
    </div>

    <div id="mErr" class="err" style="display:none;"></div>

    <!-- ✅ NEW FLOW:
         1) Send OTP
         2) Verify OTP
         3) Buy Bundle (shows ONLY after verified)
    -->
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>

      <button class="btn btn-ghost" id="sendOtpBtn" onclick="sendOtp()">Send OTP</button>

      <button class="btn" id="verifyBtn" onclick="verifyOtpOnly()" disabled>Verify OTP</button>

      <button class="btn" id="buyBtn" onclick="buyNow()" style="display:none;">Buy Bundle</button>
    </div>
  </div>
</div>

<!-- ✅ OVERLAY (Prompt / Polling) -->
<div id="overlay" class="overlay">
  <div class="overlay-card">
    <div class="spinner" id="spin"></div>
    <div id="overlayMsg" style="font-weight:700;">Please wait...</div>
    <div id="overlaySub" style="margin-top:6px;color:var(--muted);font-size:12px;">Processing</div>
    <div id="overlayErr" class="err" style="display:none;"></div>
    <div style="margin-top:14px;">
      <button class="btn btn-ghost" onclick="hideOverlay()">Close</button>
    </div>
  </div>
</div>

<script>
  // -------------------------------
  // API BASE
  // -------------------------------
  const API_BASE =
    location.hostname === "localhost"
      ? "http://localhost:8080"
      : "https://edatagh.com/edatagh-backend";

  document.addEventListener("DOMContentLoaded", loadMTNPackages);

  // -------------------------------
  // LOAD MTN PACKAGES
  // -------------------------------
  async function loadMTNPackages() {
    const box = document.getElementById("packages");
    const empty = document.getElementById("empty");

    box.innerHTML = "";
    empty.style.display = "block";
    empty.textContent = "Loading MTN packages...";

    try {
      const res = await fetch(`${API_BASE}/api/mtn-prices`);
      if (!res.ok) throw new Error("HTTP " + res.status);

      const json = await res.json();
      const data = json.rows || [];

      if (!data.length) {
        empty.textContent = "No active MTN packages found.";
        return;
      }

      empty.style.display = "none";

      box.innerHTML = data.map(p => `
        <div class="pkg">
          <h4>${escapeHtml(p.package_name)}</h4>
          <div class="price">GHS ${Number(p.price).toFixed(2)}</div>
          <div class="meta">Network: ${escapeHtml(p.network)}</div>
          <button class="btn" onclick="openBuyModal(${Number(p.id)}, '${escapeJs(p.package_name)}', ${Number(p.price)})">
            Buy Bundle
          </button>
        </div>
      `).join("");

    } catch (err) {
      console.error(err);
      empty.textContent = "Failed to load MTN packages. Check console.";
    }
  }

  // -------------------------------
  // BUY MODAL + OTP + PAY FLOW
  // -------------------------------
  let selected = { package_id:null, name:"", price:0 };
  let otpSessionId = ""; // ✅ session_id from backend /api/send-momo-otp

  function openBuyModal(package_id, name, price) {
    selected = { package_id, name, price };

    document.getElementById("mTitle").textContent = "Buy Bundle";
    document.getElementById("mSub").textContent = "Enter receiver and payer number";
    document.getElementById("mSummary").textContent = `Package: ${name} | Amount: GHS ${Number(price).toFixed(2)}`;

    document.getElementById("receiverNumber").value = "";
    document.getElementById("momoNumber").value = "";
    document.getElementById("otpCode").value = "";

    otpSessionId = ""; // ✅ always reset (prevents mismatch issues)

    document.getElementById("otpField").style.display = "none";
    document.getElementById("otpCode").disabled = false;

    // buttons reset
    const sendBtn = document.getElementById("sendOtpBtn");
    sendBtn.disabled = false;
    sendBtn.textContent = "Send OTP";

    const verifyBtn = document.getElementById("verifyBtn");
    verifyBtn.disabled = true;
    verifyBtn.textContent = "Verify OTP";

    const buyBtn = document.getElementById("buyBtn");
    buyBtn.style.display = "none";
    buyBtn.disabled = false;

    hideError();
    document.getElementById("modalBackdrop").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("modalBackdrop").style.display = "none";
  }

  function showError(msg) {
    const el = document.getElementById("mErr");
    el.style.display = "block";
    el.textContent = msg;
  }
  function hideError() {
    const el = document.getElementById("mErr");
    el.style.display = "none";
    el.textContent = "";
  }

  // ✅ Step 1: Send OTP
  async function sendOtp() {
    hideError();

    const momo = document.getElementById("momoNumber").value.trim();
    if (!momo) return showError("Enter MoMo number.");

    otpSessionId = "";
    document.getElementById("verifyBtn").disabled = true;
    document.getElementById("buyBtn").style.display = "none";

    const sendBtn = document.getElementById("sendOtpBtn");
    sendBtn.disabled = true;
    sendBtn.textContent = "Sending…";

    try {
      const res = await fetch(`${API_BASE}/api/send-momo-otp`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ momo_number: momo })
      });

      const json = await res.json();

      if (!json.ok) {
        sendBtn.disabled = false;
        sendBtn.textContent = "Send OTP";
        return showError(json.message || "Failed to send OTP.");
      }

      // ✅ MUST come from backend: { session_id: "..." }
      otpSessionId = json.session_id || "";

      if (!otpSessionId) {
        sendBtn.disabled = false;
        sendBtn.textContent = "Send OTP";
        return showError("OTP sent but session_id missing. Please try again.");
      }

      document.getElementById("otpField").style.display = "block";
      document.getElementById("verifyBtn").disabled = false;

      sendBtn.disabled = false;
      sendBtn.textContent = "Resend OTP";

    } catch (e) {
      console.error(e);
      sendBtn.disabled = false;
      sendBtn.textContent = "Send OTP";
      showError("Network error sending OTP.");
    }
  }

  // ✅ Step 2: Verify OTP ONLY
  async function verifyOtpOnly() {
    hideError();

    const momo = document.getElementById("momoNumber").value.trim();
    const otp  = document.getElementById("otpCode").value.trim();

    if (!momo) return showError("Enter MoMo number.");
    if (!otp) return showError("Enter OTP code.");
    if (!otpSessionId) return showError("Please click Send OTP again.");

    const verifyBtn = document.getElementById("verifyBtn");
    verifyBtn.disabled = true;
    verifyBtn.textContent = "Verifying…";

    try {
      const vr = await fetch(`${API_BASE}/api/verify-momo-otp`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          momo_number: momo,
          otp,
          session_id: otpSessionId
        })
      });

      const vj = await vr.json();

      if (!vj.ok) {
        verifyBtn.disabled = false;
        verifyBtn.textContent = "Verify OTP";
        return showError(vj.message || "OTP verification failed.");
      }

      // ✅ Lock OTP inputs/buttons
      document.getElementById("otpCode").disabled = true;
      document.getElementById("sendOtpBtn").disabled = true;

      verifyBtn.textContent = "Verified ✅";

      // ✅ Show buy button now
      document.getElementById("buyBtn").style.display = "inline-block";

    } catch (e) {
      console.error(e);
      verifyBtn.disabled = false;
      verifyBtn.textContent = "Verify OTP";
      showError("Network error verifying OTP.");
    }
  }

  // ✅ Step 3: Buy Bundle (trigger TheTeller prompt)
  async function buyNow() {
    hideError();

    const recipient = document.getElementById("receiverNumber").value.trim();
    const momo = document.getElementById("momoNumber").value.trim();

    if (!recipient) return showError("Enter receiver number.");
    if (!momo) return showError("Enter MoMo number.");
    if (!otpSessionId) return showError("Session missing. Please send OTP again.");

    closeModal();
    showOverlay("Please wait for prompt on your phone", "Approve the payment using your MoMo PIN");

    try {
      const pr = await fetch(`${API_BASE}/api/buy-data-theteller`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          package_id: selected.package_id,
          momo_number: momo,
          recipient_number: recipient,
          vendor_id: 1,
          session_id: otpSessionId // ✅ IMPORTANT: backend must use this in isOtpVerifiedNow(...)
        })
      });

      const pj = await pr.json();

      if (!pj.ok) {
        showOverlayError(pj.message || "Payment could not be initiated.");
        return;
      }

      pollStatus(pj.transaction_id);

    } catch (e) {
      console.error(e);
      showOverlayError("Network error. Try again.");
    }
  }

  // -------------------------------
  // STATUS POLLING
  // -------------------------------
  let pollTimer = null;

  async function pollStatus(transaction_id) {
    clearInterval(pollTimer);

    let tries = 0;
    const maxTries = 80; // ~80*4s = ~5min

    pollTimer = setInterval(async () => {
      tries++;
      try {
        const res = await fetch(`${API_BASE}/api/theteller-status?transaction_id=${encodeURIComponent(transaction_id)}`);
        const json = await res.json();

        if (json.ok && json.status === "approved") {
          clearInterval(pollTimer);
          showOverlay("Payment Successful ✅", "Order saved. Thank you!");
          document.getElementById("spin").style.display = "none";
          return;
        }

        if (json.ok && json.status === "failed") {
          clearInterval(pollTimer);
          showOverlayError("Payment failed/declined.");
          return;
        }

        if (tries >= maxTries) {
          clearInterval(pollTimer);
          showOverlayError("Timed out. If you approved, it may confirm shortly.");
        } else {
          showOverlay("Awaiting approval…", "Check your phone for the MoMo prompt");
        }

      } catch (e) {
        if (tries >= maxTries) {
          clearInterval(pollTimer);
          showOverlayError("Status check failed. Try again.");
        }
      }
    }, 4000);
  }

  // -------------------------------
  // OVERLAY
  // -------------------------------
  function showOverlay(msg, sub) {
    document.getElementById("overlay").style.display = "flex";
    document.getElementById("overlayMsg").textContent = msg || "Please wait…";
    document.getElementById("overlaySub").textContent = sub || "";
    document.getElementById("overlayErr").style.display = "none";
    document.getElementById("overlayErr").textContent = "";
    document.getElementById("spin").style.display = "block";
  }

  function showOverlayError(msg) {
    document.getElementById("overlay").style.display = "flex";
    document.getElementById("overlayMsg").textContent = "Error";
    document.getElementById("overlaySub").textContent = "";
    document.getElementById("overlayErr").style.display = "block";
    document.getElementById("overlayErr").textContent = msg || "Something went wrong.";
    document.getElementById("spin").style.display = "none";
  }

  function hideOverlay() {
    document.getElementById("overlay").style.display = "none";
    clearInterval(pollTimer);
  }

  // -------------------------------
  // HELPERS
  // -------------------------------
  function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#039;"
    }[m]));
  }
  function escapeJs(str) {
    return String(str ?? "").replace(/\\/g, "\\\\").replace(/'/g, "\\'");
  }
</script>

</body>
</html>
