<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | AFA Orders</title>

  <style>
    :root{
      --primary:#0A3D62; --accent:#1DD1A1; --bg:#F5F7FA; --card:#fff;
      --text:#0f172a; --muted:#64748b; --line:#e2e8f0; --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1000px;margin:24px auto;padding:0 14px}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 10px 24px rgba(15,23,42,.06);
      overflow:hidden
    }
    .top{
      padding:16px;
      background:linear-gradient(90deg,var(--primary),#082f49);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap
    }
    .title{font-size:18px;font-weight:900;margin:0}
    .badge{
      background:#fff;
      border:1px solid rgba(255,255,255,.3);
      color:#0f172a;
      border-radius:999px;
      padding:6px 10px;
      font-weight:900
    }
    .body{padding:16px}

    .btn{
      border:0;cursor:pointer;border-radius:12px;padding:12px 14px;font-weight:900
    }
    .btn-primary{background:var(--accent);color:#053b2a}
    .btn-muted{background:#eef2f7;color:#111827}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .smallBtn{padding:10px 12px;border-radius:10px;font-size:13px}

    .downloadBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap
    }
    .countBig{
      font-size:28px;
      font-weight:1000;
      color:#0f172a;
      line-height:1
    }
    .muted{color:var(--muted);font-size:13px}
    .statusLine{margin-top:10px;font-size:13px}

    .tableWrap{
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      margin-top:12px;
    }
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{background:#f1f5f9;color:#0f172a;font-weight:900}
    tr:last-child td{border-bottom:none}

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--line);
      background:#eef2f7;
      color:#111827
    }
    .pill.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .pill.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}

    .rowActions{display:flex;gap:8px;flex-wrap:wrap}

    /* Expand row panel */
    .expandRow td{background:#f8fafc}
    .panel{
      padding:12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    .panelTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px
    }
    .numbersBox{
      border:1px dashed var(--line);
      border-radius:12px;
      padding:10px;
      max-height:260px;
      overflow:auto;
      background:#fcfcfd;
    }
    .numItem{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:10px;
      margin-bottom:8px;
      background:#fff;
      font-weight:800;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .copyBtn{
      border:0;
      background:#eef2f7;
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:10px;
      font-weight:900;
      cursor:pointer;
      font-size:12px;
    }
    .copyBtn:hover{filter:brightness(.98)}

    /* Mobile tweaks */
    @media (max-width: 520px){
      .wrap{margin:14px auto}
      .title{font-size:16px}
      .btn{width:100%}
      .downloadBox{gap:10px}
      .countBig{font-size:26px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <h1 class="title">Admin | AFA Orders</h1>
        <span class="badge">Live</span>
      </div>

      <div class="body">
        <div class="downloadBox">
          <div>
            <div class="countBig" id="approvedCount">0</div>
            <div class="muted">Approved AFA orders ready to download</div>
          </div>

          <button class="btn btn-primary" id="downloadBtn">Download AFA Orders</button>
        </div>

        <div class="statusLine" id="statusLine"></div>

        <h3 style="margin:16px 0 8px">Downloaded Batches</h3>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Package ID</th>
                <th>Status</th>
                <th>Count</th>
                <th>Downloaded At</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="batchesBody">
              <tr><td colspan="5" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:10px">
          Tip: Tap <b>View</b> to expand and see all phone numbers in a batch.
        </div>
      </div>
    </div>
  </div>

<script>
  // ✅ backend base
  const API_BASE =
    location.hostname === "localhost"
      ? "http://localhost:8080"
      : "https://edatagh.com/edatagh-backend";

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg, ok=true){
    $("statusLine").innerHTML = ok
      ? `<span style="color:#16a34a;font-weight:900">${msg}</span>`
      : `<span style="color:#ef4444;font-weight:900">${msg}</span>`;
  }

  async function getJSON(url){
    const r = await fetch(API_BASE + url);
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return { ok:false, message:`Non-JSON response. ${text.slice(0,160)}...` }; }
  }

  async function postJSON(url, body){
    const r = await fetch(API_BASE + url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return { ok:false, message:`Non-JSON response. ${text.slice(0,160)}...` }; }
  }

  async function loadApprovedCount(){
    const r = await getJSON("/api/admin/afa/approved-count");
    if(r.ok) $("approvedCount").textContent = r.total;
  }

  function fmtDate(x){
    if(!x) return "-";
    const d = new Date(x);
    if(isNaN(d.getTime())) return String(x);
    return d.toLocaleString();
  }

  function pill(status){
    const s = String(status||"").toLowerCase();
    if(s === "delivered") return `<span class="pill ok">DELIVERED</span>`;
    if(s === "downloaded") return `<span class="pill warn">DOWNLOADED</span>`;
    return `<span class="pill">${s.toUpperCase()}</span>`;
  }

  let openPackageId = null;

  async function loadBatchDetails(packageId){
    return await getJSON(`/api/admin/afa/batch/${encodeURIComponent(packageId)}`);
  }

  function renderBatchNumbers(pkg, details) {
    const panelCell = document.querySelector(`[data-panel="${pkg}"]`);
    if (!panelCell) return;

    panelCell.style.display = "table-cell";

    const box = document.getElementById(`nums_${pkg}`);
    if (!box) return;

    if (!details || !details.ok) {
      box.innerHTML = `<div class="muted">Failed to load numbers.</div>`;
      return;
    }

    if (!details.numbers.length) {
      box.innerHTML = `<div class="muted">No numbers in this batch.</div>`;
      return;
    }

    box.innerHTML = details.numbers.map((n, idx) => `
      <div class="numItem">
        <div>#${idx + 1} — ${n}</div>
        <button class="copyBtn" data-copy="${n}">Copy</button>
      </div>
    `).join("");

    [...box.querySelectorAll("button[data-copy]")].forEach(btn => {
      btn.onclick = async () => {
        const num = btn.getAttribute("data-copy");
        try {
          await navigator.clipboard.writeText(num);
          btn.textContent = "Copied";
          setTimeout(() => (btn.textContent = "Copy"), 1200);
        } catch {
          alert("Copy failed. Number: " + num);
        }
      };
    });
  }

  async function loadBatches(){
    const r = await getJSON("/api/admin/afa/batches");
    const tb = $("batchesBody");
    tb.innerHTML = "";

    if(!r.ok){
      tb.innerHTML = `<tr><td colspan="5" class="muted">Failed to load batches</td></tr>`;
      return;
    }

    if(!r.batches.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">No downloaded batches yet.</td></tr>`;
      return;
    }

    for (const b of r.batches) {
      const pkg = b.package_id;
      const canDeliver = String(b.status).toLowerCase() === "downloaded";

      // main row
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-weight:900">${pkg}</td>
        <td>${pill(b.status)}</td>
        <td style="font-weight:900">${b.count}</td>
        <td>${fmtDate(b.downloaded_at)}</td>
        <td>
          <div class="rowActions">
            <button class="btn btn-muted smallBtn" data-view="${pkg}">
              ${openPackageId === pkg ? "Hide" : "View"}
            </button>

            <button class="btn ${canDeliver ? "btn-primary" : "btn-muted"} smallBtn"
              ${canDeliver ? "" : "disabled"}
              data-deliver="${pkg}">
              Delivered
            </button>
          </div>
        </td>
      `;
      tb.appendChild(tr);

      // expandable row
      const tr2 = document.createElement("tr");
      tr2.className = "expandRow";
      tr2.innerHTML = `
        <td colspan="5" style="display:${openPackageId === pkg ? "table-cell" : "none"}" data-panel="${pkg}">
          <div class="panel">
            <div class="panelTop">
              <div>
                <div style="font-weight:1000">Batch: ${pkg}</div>
                <div class="muted">Phone numbers in this batch</div>
              </div>
              <button class="btn btn-muted smallBtn" data-close="${pkg}">Close</button>
            </div>
            <div class="numbersBox" id="nums_${pkg}">
              <div class="muted">Loading numbers…</div>
            </div>
          </div>
        </td>
      `;
      tb.appendChild(tr2);

      // auto-load if open
      if (openPackageId === pkg) {
        const details = await loadBatchDetails(pkg);
        renderBatchNumbers(pkg, details);
      }
    }

    // view handlers
    [...tb.querySelectorAll("button[data-view]")].forEach(btn => {
      btn.onclick = async () => {
        const pkg = btn.getAttribute("data-view");
        openPackageId = (openPackageId === pkg) ? null : pkg;
        await loadBatches();
      };
    });

    // close handlers
    [...tb.querySelectorAll("button[data-close]")].forEach(btn => {
      btn.onclick = async () => {
        openPackageId = null;
        await loadBatches();
      };
    });

    // delivered handlers
    [...tb.querySelectorAll("button[data-deliver]")].forEach(btn => {
      btn.onclick = async () => {
        const pkg = btn.getAttribute("data-deliver");
        btn.disabled = true;
        btn.textContent = "Updating...";

        const r = await postJSON("/api/admin/afa/mark-delivered", { package_id: pkg });
        if(!r.ok){
          setStatus(r.message || "Failed to mark delivered.", false);
          btn.disabled = false;
          btn.textContent = "Delivered";
          return;
        }

        setStatus(`✅ Package ${pkg} marked delivered (${r.updated} rows).`, true);
        openPackageId = null;
        await loadApprovedCount();
        await loadBatches();
      };
    });
  }

  $("downloadBtn").onclick = async ()=>{
    $("downloadBtn").disabled = true;
    $("downloadBtn").textContent = "Preparing...";

    // download excel
    window.location.href = API_BASE + "/api/admin/afa/download";

    setTimeout(async ()=>{
      await loadApprovedCount();
      await loadBatches();
      $("downloadBtn").disabled = false;
      $("downloadBtn").textContent = "Download AFA Orders";
      setStatus("✅ Download started. Batch saved.", true);
    }, 2500);
  };

  // init
  (async ()=>{
    await loadApprovedCount();
    await loadBatches();
  })();
</script>
</body>
</html>
