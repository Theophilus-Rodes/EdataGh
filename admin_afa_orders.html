<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | AFA Orders</title>
  <style>
    :root{
      --primary:#0A3D62; --accent:#1DD1A1; --bg:#F5F7FA; --card:#fff;
      --text:#0f172a; --muted:#64748b; --line:#e2e8f0; --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1000px;margin:24px auto;padding:0 14px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:14px;
      box-shadow:0 10px 24px rgba(15,23,42,.06);overflow:hidden
    }
    .top{
      padding:16px;background:linear-gradient(90deg,var(--primary),#082f49);
      color:#fff;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap
    }
    .title{font-size:18px;font-weight:900;margin:0}
    .btn{
      border:0;cursor:pointer;border-radius:12px;padding:12px 14px;font-weight:900
    }
    .btn-primary{background:var(--accent);color:#053b2a}
    .btn-muted{background:#eef2f7;color:#111827}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .body{padding:16px}
    .downloadBox{
      border:1px solid var(--line);border-radius:14px;padding:14px;background:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap
    }
    .badge{
      background:#fff;border:1px solid rgba(255,255,255,.3);
      color:#0f172a;border-radius:999px;padding:6px 10px;font-weight:900
    }
    .countBig{
      font-size:28px;font-weight:1000;color:#0f172a;line-height:1
    }
    .muted{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{background:#f1f5f9;color:#0f172a;font-weight:900}
    tr:last-child td{border-bottom:none}
    .pill{
      display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;
      border:1px solid var(--line);background:#eef2f7;color:#111827
    }
    .pill.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .pill.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .rowActions{display:flex;gap:8px;flex-wrap:wrap}
    .statusLine{margin-top:10px;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <h1 class="title">Admin | AFA Orders</h1>
        <span class="badge">Live</span>
      </div>

      <div class="body">
        <div class="downloadBox">
          <div>
            <div class="countBig" id="approvedCount">0</div>
            <div class="muted">Approved AFA orders ready to download</div>
          </div>

          <button class="btn btn-primary" id="downloadBtn">
            Download AFA Orders
          </button>
        </div>

        <div class="statusLine" id="statusLine"></div>

        <h3 style="margin:16px 0 8px">Downloaded Batches</h3>
        <table>
          <thead>
            <tr>
              <th>Package ID</th>
              <th>Status</th>
              <th>Count</th>
              <th>Downloaded At</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="batchesBody">
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // ✅ set base (same rule you used)
  const API_BASE =
    location.hostname === "localhost"
      ? "http://localhost:8080"
      : "https://edatagh.com/edatagh-backend";

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg, ok=true){
    $("statusLine").innerHTML = ok
      ? `<span style="color:#16a34a;font-weight:900">${msg}</span>`
      : `<span style="color:#ef4444;font-weight:900">${msg}</span>`;
  }

  async function getJSON(url){
    const r = await fetch(API_BASE + url);
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return { ok:false, message:`Non-JSON response. ${text.slice(0,120)}...` }; }
  }

  async function postJSON(url, body){
    const r = await fetch(API_BASE + url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return { ok:false, message:`Non-JSON response. ${text.slice(0,120)}...` }; }
  }

  async function loadApprovedCount(){
    const r = await getJSON("/api/admin/afa/approved-count");
    if(r.ok) $("approvedCount").textContent = r.total;
  }

  function fmtDate(x){
    if(!x) return "-";
    const d = new Date(x);
    if(isNaN(d.getTime())) return String(x);
    return d.toLocaleString();
  }

  function pill(status){
    const s = String(status||"").toLowerCase();
    if(s === "delivered") return `<span class="pill ok">DELIVERED</span>`;
    if(s === "downloaded") return `<span class="pill warn">DOWNLOADED</span>`;
    return `<span class="pill">${s.toUpperCase()}</span>`;
  }

  async function loadBatches(){
    const r = await getJSON("/api/admin/afa/batches");
    const tb = $("batchesBody");
    tb.innerHTML = "";

    if(!r.ok){
      tb.innerHTML = `<tr><td colspan="5" class="muted">Failed to load batches</td></tr>`;
      return;
    }

    if(!r.batches.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">No downloaded batches yet.</td></tr>`;
      return;
    }

    r.batches.forEach(b=>{
      const canDeliver = String(b.status).toLowerCase() === "downloaded";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-weight:900">${b.package_id}</td>
        <td>${pill(b.status)}</td>
        <td style="font-weight:900">${b.count}</td>
        <td>${fmtDate(b.downloaded_at)}</td>
        <td>
          <div class="rowActions">
            <button class="btn ${canDeliver ? "btn-primary" : "btn-muted"}"
              ${canDeliver ? "" : "disabled"}
              data-pkg="${b.package_id}">
              Delivered
            </button>
          </div>
        </td>
      `;
      tb.appendChild(tr);
    });

    // attach deliver handlers
    [...tb.querySelectorAll("button[data-pkg]")].forEach(btn=>{
      btn.onclick = async ()=>{
        const pkg = btn.getAttribute("data-pkg");
        btn.disabled = true;
        btn.textContent = "Updating...";

        const r = await postJSON("/api/admin/afa/mark-delivered", { package_id: pkg });
        if(!r.ok){
          setStatus(r.message || "Failed to mark delivered.", false);
          btn.disabled = false;
          btn.textContent = "Delivered";
          return;
        }
        setStatus(`✅ Package ${pkg} marked delivered (${r.updated} rows).`, true);
        await loadBatches();
      };
    });
  }

  $("downloadBtn").onclick = async ()=>{
    $("downloadBtn").disabled = true;
    $("downloadBtn").textContent = "Preparing...";

    // open file download in new navigation
    // (browser will download Excel automatically)
    window.location.href = API_BASE + "/api/admin/afa/download";

    // Refresh counts & batches shortly after
    setTimeout(async ()=>{
      await loadApprovedCount();
      await loadBatches();
      $("downloadBtn").disabled = false;
      $("downloadBtn").textContent = "Download AFA Orders";
    }, 2500);
  };

  // init
  (async ()=>{
    await loadApprovedCount();
    await loadBatches();
  })();
</script>
</body>
</html>
