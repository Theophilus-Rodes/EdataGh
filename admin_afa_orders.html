<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | AFA Orders</title>

  <style>
    :root{
      --primary:#0A3D62; --accent:#1DD1A1; --bg:#F5F7FA; --card:#fff;
      --text:#0f172a; --muted:#64748b; --line:#e2e8f0; --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 14px}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 10px 24px rgba(15,23,42,.06);
      overflow:hidden
    }
    .top{
      padding:16px;
      background:linear-gradient(90deg,var(--primary),#082f49);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap
    }
    .title{font-size:18px;font-weight:900;margin:0}
    .badge{
      background:#fff;
      border:1px solid rgba(255,255,255,.3);
      color:#0f172a;
      border-radius:999px;
      padding:6px 10px;
      font-weight:900
    }
    .body{padding:16px}

    .btn{
      border:0;cursor:pointer;border-radius:12px;padding:12px 14px;font-weight:900
    }
    .btn-primary{background:var(--accent);color:#053b2a}
    .btn-muted{background:#eef2f7;color:#111827}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .smallBtn{padding:10px 12px;border-radius:10px;font-size:13px}

    .downloadBox{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap
    }
    .countBig{
      font-size:28px;
      font-weight:1000;
      color:#0f172a;
      line-height:1
    }
    .muted{color:var(--muted);font-size:13px}
    .statusLine{margin-top:10px;font-size:13px}

    .tableWrap{
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      margin-top:12px;
    }
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:14px;vertical-align:top}
    th{background:#f1f5f9;color:#0f172a;font-weight:900}
    tr:last-child td{border-bottom:none}

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--line);
      background:#eef2f7;
      color:#111827
    }
    .pill.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .pill.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}

    .rowActions{display:flex;gap:8px;flex-wrap:wrap}

    /* Expanded details */
    .expandRow td{background:#f8fafc}
    .panel{
      padding:12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    .panelTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px
    }
    .panelTitle{font-weight:1000}
    .detailWrap{
      overflow:auto;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    .detailTable{width:100%;border-collapse:collapse;min-width:820px}
    .detailTable th,.detailTable td{padding:10px;border-bottom:1px solid var(--line);font-size:13px}
    .detailTable th{background:#f8fafc;font-weight:900}

    .copyBtn{
      border:0;background:#eef2f7;border:1px solid var(--line);
      padding:8px 10px;border-radius:10px;font-weight:900;cursor:pointer;font-size:12px;
      white-space:nowrap;
    }
    .copyBtn:hover{filter:brightness(.98)}

    @media (max-width: 520px){
      .wrap{margin:14px auto}
      .title{font-size:16px}
      .btn{width:100%}
      .countBig{font-size:26px}
      table{min-width:720px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <h1 class="title">Admin | AFA Orders</h1>
        <span class="badge">Live</span>
      </div>

      <div class="body">
        <div class="downloadBox">
          <div>
            <div class="countBig" id="approvedCount">0</div>
            <div class="muted">Approved AFA orders ready to download</div>
          </div>

          <button class="btn btn-primary" id="downloadBtn">Download AFA Orders</button>
        </div>

        <div class="statusLine" id="statusLine"></div>

        <h3 style="margin:16px 0 8px">Downloaded Batches</h3>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Package ID</th>
                <th>Status</th>
                <th>Count</th>
                <th>Downloaded At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="batchesBody">
              <tr><td colspan="5" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:10px">
          Tap <b>View</b> to see full details: package_id, phone_number, momo_number, amount, status.
        </div>
      </div>
    </div>
  </div>

<script>
  const API_BASE =
    location.hostname === "localhost"
      ? "http://localhost:8080"
      : "https://edatagh.com/edatagh-backend";

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg, ok=true){
    $("statusLine").innerHTML = ok
      ? `<span style="color:#16a34a;font-weight:900">${msg}</span>`
      : `<span style="color:#ef4444;font-weight:900">${msg}</span>`;
  }

  async function getJSON(url){
    const r = await fetch(API_BASE + url);
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return { ok:false, message:`Non-JSON response. ${text.slice(0,160)}...` }; }
  }

  async function postJSON(url, body){
    const r = await fetch(API_BASE + url, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return { ok:false, message:`Non-JSON response. ${text.slice(0,160)}...` }; }
  }

  async function loadApprovedCount(){
    const r = await getJSON("/api/admin/afa/approved-count");
    if(r.ok) $("approvedCount").textContent = r.total;
  }

  function fmtDate(x){
    if(!x) return "-";
    const d = new Date(x);
    if(isNaN(d.getTime())) return String(x);
    return d.toLocaleString();
  }

  function pill(status){
    const s = String(status||"").toLowerCase();
    if(s === "delivered") return `<span class="pill ok">DELIVERED</span>`;
    if(s === "downloaded") return `<span class="pill warn">DOWNLOADED</span>`;
    return `<span class="pill">${s.toUpperCase()}</span>`;
  }

  let openPackageId = null;
  const detailsCache = new Map();

  async function fetchBatchDetails(pkg){
    if(detailsCache.has(pkg)) return detailsCache.get(pkg);
    const r = await getJSON(`/api/admin/afa/batch/${encodeURIComponent(pkg)}`);
    detailsCache.set(pkg, r);
    return r;
  }

  async function loadBatches(){
    const r = await getJSON("/api/admin/afa/batches");
    const tb = $("batchesBody");
    tb.innerHTML = "";

    if(!r.ok){
      tb.innerHTML = `<tr><td colspan="5" class="muted">Failed to load batches</td></tr>`;
      return;
    }

    if(!r.batches.length){
      tb.innerHTML = `<tr><td colspan="5" class="muted">No downloaded batches yet.</td></tr>`;
      return;
    }

    for (const b of r.batches) {
      const pkg = b.package_id;
      const canDeliver = String(b.status).toLowerCase() === "downloaded";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-weight:900">${pkg}</td>
        <td>${pill(b.status)}</td>
        <td style="font-weight:900">${b.count}</td>
        <td>${fmtDate(b.downloaded_at)}</td>
        <td>
          <div class="rowActions">
            <button class="btn btn-muted smallBtn" data-view="${pkg}">
              ${openPackageId === pkg ? "Hide" : "View"}
            </button>

            <button class="btn ${canDeliver ? "btn-primary" : "btn-muted"} smallBtn"
              ${canDeliver ? "" : "disabled"}
              data-deliver="${pkg}">
              Delivered
            </button>
          </div>
        </td>
      `;
      tb.appendChild(tr);

      const tr2 = document.createElement("tr");
      tr2.className = "expandRow";
      tr2.innerHTML = `
        <td colspan="5" style="display:${openPackageId === pkg ? "table-cell" : "none"}" data-panel="${pkg}">
          <div class="panel">
            <div class="panelTop">
              <div>
                <div class="panelTitle">Batch: ${pkg}</div>
                <div class="muted">Full details inside this batch</div>
              </div>
              <button class="btn btn-muted smallBtn" data-close="${pkg}">Close</button>
            </div>

            <div class="detailWrap">
              <table class="detailTable">
                <thead>
                  <tr>
                    <th>Package ID</th>
                    <th>Phone Number</th>
                    <th>MoMo Number</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Copy</th>
                  </tr>
                </thead>
                <tbody id="detail_${pkg}">
                  <tr><td colspan="6" class="muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </td>
      `;
      tb.appendChild(tr2);

      if (openPackageId === pkg) {
        const details = await fetchBatchDetails(pkg);
        renderDetails(pkg, details);
      }
    }

    // View
    [...tb.querySelectorAll("button[data-view]")].forEach(btn => {
      btn.onclick = async () => {
        const pkg = btn.getAttribute("data-view");
        openPackageId = (openPackageId === pkg) ? null : pkg;

        await loadBatches();

        if (openPackageId === pkg) {
          const details = await fetchBatchDetails(pkg);
          renderDetails(pkg, details);
        }
      };
    });

    // Close
    [...tb.querySelectorAll("button[data-close]")].forEach(btn => {
      btn.onclick = async () => {
        openPackageId = null;
        await loadBatches();
      };
    });

    // Delivered
    [...tb.querySelectorAll("button[data-deliver]")].forEach(btn => {
      btn.onclick = async () => {
        const pkg = btn.getAttribute("data-deliver");
        btn.disabled = true;
        btn.textContent = "Updating...";

        const r = await postJSON("/api/admin/afa/mark-delivered", { package_id: pkg });
        if(!r.ok){
          setStatus(r.message || "Failed to mark delivered.", false);
          btn.disabled = false;
          btn.textContent = "Delivered";
          return;
        }

        setStatus(`✅ Package ${pkg} marked delivered (${r.updated} rows).`, true);
        openPackageId = null;
        detailsCache.clear();
        await loadApprovedCount();
        await loadBatches();
      };
    });
  }

  function renderDetails(pkg, details){
    const tbody = document.getElementById(`detail_${pkg}`);
    if(!tbody) return;

    if(!details || !details.ok){
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Failed to load details (check backend route).</td></tr>`;
      return;
    }

    if(!details.items || !details.items.length){
      tbody.innerHTML = `<tr><td colspan="6" class="muted">No records in this batch.</td></tr>`;
      return;
    }

    tbody.innerHTML = details.items.map((x) => `
      <tr>
        <td>${x.package_id || ""}</td>
        <td style="font-weight:900">${x.phone_number || ""}</td>
        <td>${x.momo_number || ""}</td>
        <td>${x.amount || ""}</td>
        <td>${pill(x.status)}</td>
        <td>
          <button class="copyBtn" data-copy="${x.phone_number || ""}">Copy</button>
        </td>
      </tr>
    `).join("");

    [...tbody.querySelectorAll("button[data-copy]")].forEach(btn => {
      btn.onclick = async ()=>{
        const num = btn.getAttribute("data-copy");
        try{
          await navigator.clipboard.writeText(num);
          btn.textContent = "Copied";
          setTimeout(()=> btn.textContent = "Copy", 1000);
        }catch{
          alert("Copy failed. Number: " + num);
        }
      };
    });
  }

  $("downloadBtn").onclick = async ()=>{
    $("downloadBtn").disabled = true;
    $("downloadBtn").textContent = "Preparing...";

    // start download
    window.location.href = API_BASE + "/api/admin/afa/download";

    setTimeout(async ()=>{
      detailsCache.clear();
      await loadApprovedCount();
      await loadBatches();
      $("downloadBtn").disabled = false;
      $("downloadBtn").textContent = "Download AFA Orders";
      setStatus("✅ Download started. Batch saved.", true);
    }, 2500);
  };

  (async ()=>{
    await loadApprovedCount();
    await loadBatches();
  })();
</script>
</body>
</html>
